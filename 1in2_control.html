<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMMAND CENTER | 1in2 Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap');
        .orbitron { font-family: 'Orbitron', sans-serif; }
        .glass { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(220, 38, 38, 0.2); }
        body { background: #000; color: #fff; overflow: hidden; }
        .glow-red { box-shadow: 0 0 30px rgba(220, 38, 38, 0.2); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

<div class="glass p-6 rounded-[2rem] border border-white/5 bg-black text-white max-w-sm mx-auto shadow-2xl">
    <div class="flex justify-between items-center mb-6">
        <h3 class="orbitron text-[10px] font-black uppercase tracking-[0.4em] text-red-600">Lobby Registry</h3>
        <span id="reg-count" class="text-xs font-black bg-white/10 px-2 py-1 rounded">0/2</span>
    </div>

    <div id="registry-list" class="space-y-2 mb-6">
        </div>

    <button onclick="executeNuclearOffload()" 
        class="w-full py-4 bg-red-600 hover:bg-white hover:text-black text-white rounded-xl font-black uppercase italic text-[10px] tracking-widest transition-all active:scale-95 shadow-lg shadow-red-900/20">
        Purge All & Reset Arena
    </button>
</div>


<div class="glass p-8 rounded-[2rem] border border-red-900/20 bg-black shadow-2xl mt-6 relative overflow-hidden">
    <div class="absolute -top-24 -right-24 w-48 h-48 bg-red-600/10 blur-[100px] rounded-full"></div>

    <div class="flex justify-between items-center mb-8">
        <div>
            <h3 class="orbitron text-white text-[10px] font-black uppercase tracking-[0.5em] italic">Arena 1in2</h3>
            <p class="text-[9px] text-zinc-500 font-black uppercase mt-1">Status: <span id="lobby-status" class="text-zinc-700 italic">Standby</span></p>
        </div>
        <div id="status-light" class="w-2 h-2 bg-zinc-800 rounded-full"></div>
    </div>

    <button onclick="activateLobby()" 
        class="group relative w-full py-5 bg-white hover:bg-red-600 transition-all duration-300 rounded-xl overflow-hidden">
        <span class="relative z-10 orbitron text-black group-hover:text-white font-black uppercase text-[12px] tracking-widest">
            Open Lobby & Start Timer
        </span>
        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
    </button>
</div>

<script>
    async function activateLobby() {
        if(!confirm("START ARENA COUNTDOWN?")) return;

        // UI Feedback
        const btn = event.currentTarget;
        const statusText = document.getElementById('lobby-status');
        const light = document.getElementById('status-light');
        
        btn.disabled = true;
        btn.style.opacity = "0.5";
        statusText.innerText = "COMMAND SENT...";

        try {
            const { error } = await sb.rpc('open_lobby_1in2');
            
            if (error) throw error;

            // Success Visuals
            statusText.innerText = "ARENA LIVE";
            statusText.className = "text-red-600 italic animate-pulse";
            light.className = "w-2 h-2 bg-red-600 rounded-full shadow-[0_0_10px_rgba(220,38,38,0.8)]";
            
            console.log("Lobby is now open. Countdown started.");

        } catch (err) {
            alert("ACTIVATION FAILED: " + err.message);
            statusText.innerText = "OFFLINE";
        } finally {
            setTimeout(() => {
                btn.disabled = false;
                btn.style.opacity = "1";
            }, 2000);
        }
    }

    // Optional: Real-time listener to keep Admin UI in sync
    sb.channel('admin_registry_sync')
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'Leagues_Registry' }, payload => {
            const reg = payload.new;
            if(reg.id === '1in2') {
                const statusText = document.getElementById('lobby-status');
                const light = document.getElementById('status-light');
                if(reg.is_active) {
                    statusText.innerText = "ARENA LIVE";
                    statusText.className = "text-red-600 italic";
                    light.className = "w-2 h-2 bg-red-600 rounded-full shadow-[0_0_10px_rgba(220,38,38,0.8)]";
                }
            }
        }).subscribe();
</script>



    



<script>
    // USES YOUR EXISTING 'sb' CLIENT
    async function syncRegistry() {
        const { data: players } = await sb.from('1in2').select('player_username').order('created_at');
        const list = document.getElementById('registry-list');
        const count = document.getElementById('reg-count');
        
        count.innerText = `${players?.length || 0}/2`;
        
        if (!players || players.length === 0) {
            list.innerHTML = `<p class="text-[9px] text-zinc-600 text-center py-4 uppercase font-black italic border border-zinc-900 rounded-xl">Registry Empty</p>`;
            return;
        }

        list.innerHTML = players.map(p => `
            <div class="flex justify-between items-center bg-zinc-900/50 p-3 rounded-xl border border-white/5">
                <span class="text-[11px] font-black uppercase tracking-tighter">${p.player_username}</span>
                <button onclick="executeSurgicalOffload('${p.player_username}')" 
                    class="text-[9px] font-black text-red-500 hover:text-white uppercase">
                    [ Offload ]
                </button>
            </div>
        `).join('');
    }

    // Surgical Execution
    async function executeSurgicalOffload(username) {
        if (!confirm(`OFFLOAD ${username}?`)) return;
        const { error } = await sb.rpc('offload_player_1in2', { target_username: username });
        if (error) alert("Error: " + error.message);
        syncRegistry();
    }

    // Nuclear Execution
    async function executeNuclearOffload() {
        if (!confirm("PURGE ALL REGISTRY DATA?")) return;
        const { error } = await sb.rpc('nuclear_offload_1in2');
        if (error) alert("Error: " + error.message);
        syncRegistry();
    }

    // Live Pulse Listener
    sb.channel('admin_registry').on('postgres_changes', { event: '*', schema: 'public', table: '1in2' }, syncRegistry).subscribe();
    syncRegistry();
</script>

</body>
</html>
