<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>1in2 Lobby | Chicken League</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&family=Orbitron:wght@900&display=swap');
body { background:#000;color:#eff3f4;font-family:'Inter',sans-serif;-webkit-font-smoothing:antialiased; }
.font-chirp{font-weight:900;letter-spacing:-0.04em}
.orbitron{font-family:'Orbitron',sans-serif}
.glass-panel{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:1.5rem;padding:2rem;}
.slot-circle{width:85px;height:85px;border-radius:1rem;border:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.02);transition:0.3s;}
.slot-filled{background:#fff;border-color:#fff;box-shadow:0 0 20px rgba(255,255,255,.15);}
.btn-join{background:#fff;color:#000;transition:0.3s;}
.btn-join:disabled{opacity:0.4;cursor:not-allowed;}
.btn-arena-locked{background:#111;color:#555;border:1px solid #222;}
.btn-arena-ready{background:red;color:#fff;box-shadow:0 0 20px rgba(255,0,0,.4);}
</style>
</head>

<body class="pt-20 pb-32">
<main class="max-w-md mx-auto px-6">

<!-- HEADER -->
<div class="flex justify-between items-center mb-6">
<h2 class="font-chirp text-xl uppercase italic">Arena <span class="text-red-600">Lobby</span></h2>
<span id="count_display" class="orbitron text-sm bg-white/10 px-3 py-1 rounded">0/2</span>
</div>

<!-- ARENA IMAGE -->
<div class="mb-6">
  <div class="h-48 bg-cover bg-center rounded-2xl border-b-2 border-red-600"
       style="background-image:url('https://i.ibb.co/FbCS1n9p/IMG-2638.jpg');"></div>
  <div class="py-4 flex justify-between items-start">
    <div>
      <h1 class="text-2xl font-chirp uppercase leading-none italic">Trial Broiler</h1>
      <p class="text-red-500 text-[9px] font-black uppercase tracking-[0.2em] mt-2">1v1 Continuous Weight Duel</p>
    </div>
  </div>
</div>

<!-- SLOTS -->
<div class="glass-panel mb-8">
  <div class="flex gap-8 justify-center items-center">
    <div class="flex flex-col items-center gap-2">
      <div id="slot-0" class="slot-circle"></div>
      <span id="name-0" class="text-[10px] uppercase text-zinc-500">OPEN SLOT</span>
    </div>
    <div class="orbitron text-zinc-800 font-black text-xl">VS</div>
    <div class="flex flex-col items-center gap-2">
      <div id="slot-1" class="slot-circle"></div>
      <span id="name-1" class="text-[10px] uppercase text-zinc-500">OPEN SLOT</span>
    </div>
  </div>
</div>

<!-- BUTTONS -->
<div class="grid grid-cols-2 gap-3">
<button id="joinBtn" class="py-5 btn-join rounded-xl font-chirp uppercase">Join Lobby</button>
<button id="arenaBtn" class="py-5 btn-arena-locked rounded-xl font-chirp uppercase" disabled>Arena Locked</button>
</div>

</main>

<script>
// === INIT SUPABASE CLIENT ===
const sb = supabase.createClient(
  "https://tbvmgcknkwsucstedigd.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRidm1nY2tua3dzdWNzdGVkaWdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5ODgwMjQsImV4cCI6MjA4MzU2NDAyNH0.OhfvqWaGLwNvIJq8TBDomdtKWDII5MvC6zhKKJBUD9Q"
);

const LEAGUE_NAME = "1in2";
let league = null;
let players = [];
let currentUser = null;
let isProcessing = false;
let subscription = null;

/* INIT */
async function init() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { location.href = "login.html"; return; }

  currentUser = {
    id: session.user.id,
    username: session.user.user_metadata.username
  };

  await loadLobby();
  setupJoinButton();
}

/* LOAD DATA */
async function loadLobby() {
  const { data: lg, error: lgError } = await sb.from('leagues').select('*').eq('name', LEAGUE_NAME).single();
  if (lgError) { console.error("League Load Error:", lgError); return; }
  league = lg;

  const { data: pls, error: plError } = await sb.from('league_players')
    .select('*')
    .eq('league_id', league.id)
    .order('joined_at', { ascending: true });

  if(plError) { console.error("Players Load Error:", plError); return; }
  players = pls || [];

  render();
  subscribeRealtime();
}

/* RENDER UI */
function render() {
  document.getElementById("count_display").innerText = `${players.length}/${league.max_players}`;

  for (let i=0; i<2; i++) {
    const slot = document.getElementById(`slot-${i}`);
    const name = document.getElementById(`name-${i}`);
    const p = players[i];

    if(p){
      slot.classList.add("slot-filled");
      slot.innerHTML = `<span class="text-black font-black text-2xl">${p.username[0].toUpperCase()}</span>`;
      name.innerText = p.username;
      name.className = "text-[10px] uppercase text-white";
    } else {
      slot.classList.remove("slot-filled");
      slot.innerHTML = "";
      name.innerText = "OPEN SLOT";
      name.className = "text-[10px] uppercase text-zinc-500";
    }
  }

  const joined = players.some(p=>p.user_id===currentUser.id);
  const joinBtn = document.getElementById("joinBtn");
  joinBtn.disabled = joined || players.length >= league.max_players;
  joinBtn.innerText = joined ? "Lobby Joined" : (players.length>=league.max_players ? "Lobby Full" : "Join Lobby");

  const arenaBtn = document.getElementById("arenaBtn");
  arenaBtn.disabled = !joined;
  arenaBtn.className = joined ? "py-5 btn-arena-ready rounded-xl font-chirp uppercase" : "py-5 btn-arena-locked rounded-xl font-chirp uppercase";
}

/* JOIN */
function setupJoinButton() {
  const joinBtn = document.getElementById("joinBtn");
  joinBtn.addEventListener("click", async () => {
    if (isProcessing) return;
    isProcessing = true;

    if(players.some(p=>p.user_id===currentUser.id)) { isProcessing=false; return; }
    if(players.length >= league.max_players) { alert("Lobby Full"); isProcessing=false; return; }

    const { error } = await sb.from('league_players').insert({
      league_id: league.id,
      user_id: currentUser.id,
      username: currentUser.username
    });

    if(error) { alert("Join Failed: " + error.message); isProcessing=false; return; }

    await loadLobby();
    isProcessing = false;
  });
}

/* REALTIME SUBSCRIPTION */
function subscribeRealtime() {
  if(!league) return;
  if(subscription) { subscription.unsubscribe(); subscription=null; }

  subscription = sb.channel("league-" + LEAGUE_NAME)
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'league_players',
      filter: `league_id=eq.${league.id}`
    }, loadLobby)
    .subscribe();
}

init();
</script>
</body>
</html>
