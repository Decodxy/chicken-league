// ... [Keep your variable declarations at the top]

async function joinLobby() {
    if (isProcessing) return;
    isProcessing = true;
    
    const joinBtn = document.getElementById('joinBtn');
    const originalText = joinBtn.innerText;
    
    // 1. UI FEEDBACK - SHOW "SIGNALING" STATE
    joinBtn.innerText = "LINKING TO ARENA...";
    joinBtn.disabled = true;

    try {
        // 2. ATOMIC EXECUTION - CALL THE SQL PROGRAM
        const { error } = await sb.rpc('join_league_1in2', { 
            player_name: currentUser 
        });

        if (error) {
            // RUTHLESS ERROR HANDLING
            if (error.message.includes('ARENA_FULL')) {
                alert("ARENA FULL: Your rival beat you to the slot.");
            } else if (error.message.includes('ALREADY_JOINED')) {
                alert("DENIED: You are already in this lobby.");
            } else {
                alert("COMMUNICATION ERROR: Check your internet or Supabase RLS.");
            }
            throw error;
        }

        // 3. CONFIRMATION
        console.log("DATABASE SYNC SUCCESSFUL");
        await syncLobby(); // Re-fetch the truth from the server

    } catch (err) {
        console.error("Join Sequence Failed:", err);
        joinBtn.innerText = originalText;
        joinBtn.disabled = false;
    } finally {
        isProcessing = false;
        updateUI();
    }
}

// Ensure the real-time subscription is actually listening for the TRUTH
async function init() {
    const { data: { session } } = await sb.auth.getSession();
    if (!session) { window.location.href = "login.html"; return; }
    currentUser = session.user.user_metadata.username;
    
    await syncLobby();
    
    // THE REAL-TIME HEARTBEAT
    sb.channel('lobby_gate')
        .on('postgres_changes', { 
            event: '*', 
            schema: 'public', 
            table: '1in2' 
        }, (payload) => {
            console.log("DATABASE UPDATE DETECTED:", payload.eventType);
            syncLobby(); // Trigger UI refresh from server truth
        })
        .subscribe();
}
