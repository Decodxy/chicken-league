<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1 IN 2 Duel | Chicken League</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #050505; color: white; font-family: 'Inter', sans-serif; min-height: 100vh; }
        .glass-panel { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        /* PREMIUM CIRCLE SLOTS */
        .slot-ring { 
            width: 80px; height: 80px; border-radius: 50%; 
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        /* THE ACTIVATED GLOW */
        .slot-active { 
            border-color: #f97316; 
            box-shadow: 0 0 30px rgba(249, 115, 22, 0.4), inset 0 0 15px rgba(249, 115, 22, 0.2);
            background: rgba(249, 115, 22, 0.1);
        }
        .slot-active::after {
            content: "READY";
            font-size: 8px; font-weight: 900; color: #f97316;
            letter-spacing: 1px;
        }

        .pulse-arena { animation: arenaPulse 2s infinite; }
        @keyframes arenaPulse {
            0% { box-shadow: 0 0 0 0px rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0px rgba(34, 197, 94, 0); }
        }
    </style>
</head>
<body class="p-6">

    <div id="battle_alert" class="hidden sticky top-0 z-50 w-full p-4 bg-green-600 text-center font-black text-xs italic tracking-widest uppercase">
        Arena Signal Detected • Proceed to Combat
    </div>

    <main class="max-w-md mx-auto">
        <header class="flex justify-between items-center mb-10 pt-4">
            <a href="dashboard.html" class="text-[10px] font-black text-gray-600 uppercase tracking-widest hover:text-white transition">← Abort</a>
            <div class="text-right">
                <p id="count_display" class="text-xs font-black text-orange-500 uppercase italic">0 / 2 JOINED</p>
            </div>
        </header>

        <div class="glass-panel rounded-[2rem] overflow-hidden mb-10 border-b-2 border-orange-600/50">
            <div class="h-32 bg-cover bg-center opacity-80" style="background-image: url('https://i.ibb.co/qYSmTyxm/IMG-2414.png');"></div>
            <div class="p-4 bg-gradient-to-b from-transparent to-black">
                <h1 class="text-xl font-black italic uppercase tracking-tighter">The Trial Broiler</h1>
            </div>
        </div>

        <div class="glass-panel p-10 rounded-[3rem] mb-10 flex justify-center gap-10">
            <div id="slot-0" class="slot-ring"></div>
            <div id="slot-1" class="slot-ring"></div>
        </div>

        <button id="joinBtn" onclick="joinLobby()" class="w-full py-6 bg-orange-600 rounded-3xl font-black uppercase italic tracking-widest text-sm shadow-2xl transition-all duration-500 active:scale-95">
            Join Duel
        </button>
    </main>

    <script>
        const SB_URL = 'https://tbvmgcknkwsucstedigd.supabase.co';
        const SB_KEY = 'YOUR_ACTUAL_KEY'; 
        const sb = window.supabase.createClient(SB_URL, SB_KEY);
        const user = localStorage.getItem('league_user');
        let countdownInterval = null;

        async function syncLobby() {
            const { data: players, error } = await sb.from('1in2').select('*');
            const { data: signal } = await sb.from('Lobby_Signals').select('*').eq('lobby_id', '1in2').single();
            
            if (error) return;

            const total = players ? players.length : 0;
            const isUserIn = players.some(p => p.player_username === user);
            
            // 1. UPDATE UI TEXT
            document.getElementById('count_display').innerText = `${total} / 2 JOINED`;

            // 2. LIGHT UP SLOTS
            for(let i=0; i<2; i++) {
                const slot = document.getElementById(`slot-${i}`);
                if (players[i]) {
                    slot.classList.add('slot-active');
                } else {
                    slot.classList.remove('slot-active');
                }
            }

            const btn = document.getElementById('joinBtn');

            // 3. LOGIC FOR LOBBY FULL (2/2)
            if (total >= 2) {
                const now = new Date().getTime();
                const target = signal?.target_time ? new Date(signal.target_time).getTime() : null;
                const isLive = signal?.is_live;

                if (isLive || (target && now >= target)) {
                    if(countdownInterval) clearInterval(countdownInterval);
                    document.getElementById('battle_alert').classList.remove('hidden');
                    
                    if (isUserIn) {
                        btn.innerText = "Enter Arena";
                        btn.disabled = false;
                        btn.className = "w-full py-6 bg-green-600 rounded-3xl font-black uppercase italic tracking-widest pulse-arena";
                        btn.onclick = () => window.location.href = '1in2arena.html';
                    } else {
                        btn.innerText = "Lobby Full";
                        btn.disabled = true;
                        btn.className = "w-full py-6 bg-gray-900 rounded-3xl font-black uppercase italic opacity-30 text-gray-600";
                    }
                } else if (target && now < target) {
                    if (isUserIn) {
                        if(!countdownInterval) countdownInterval = setInterval(syncLobby, 1000);
                        const diff = target - now;
                        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const secs = Math.floor((diff % (1000 * 60)) / 1000);
                        btn.innerText = `LOCKED: ${mins}m ${secs}s`;
                        btn.disabled = true;
                        btn.className = "w-full py-6 bg-blue-900/40 rounded-3xl font-black uppercase italic text-blue-400 border border-blue-500/30";
                    }
                } else {
                    if (isUserIn) {
                        btn.innerText = "Awaiting Signal...";
                        btn.disabled = true;
                        btn.className = "w-full py-6 bg-gray-900 rounded-3xl font-black uppercase italic text-gray-500 opacity-50";
                    }
                }
            } 
            // 4. LOGIC FOR USER ALREADY IN (1/2)
            else if (isUserIn) {
                btn.innerText = "Joined • Waiting...";
                btn.disabled = true;
                btn.className = "w-full py-6 bg-gray-900 rounded-3xl font-black uppercase italic text-gray-500 border border-white/5 opacity-50";
            } 
            // 5. DEFAULT JOIN STATE
            else {
                btn.innerText = "Join Duel";
                btn.disabled = false;
                btn.className = "w-full py-6 bg-orange-600 rounded-3xl font-black uppercase italic tracking-widest shadow-2xl hover:bg-orange-500";
                btn.onclick = joinLobby;
            }
        }

        async function joinLobby() {
            if(!user) return;
            const { error } = await sb.from('1in2').insert([{ player_username: user }]);
            if (error) {
                console.error("Join Error");
            }
            syncLobby();
        }

        // Real-time Subscriptions
        sb.channel('1in2_sync')
          .on('postgres_changes', { event: '*', table: '1in2' }, syncLobby)
          .on('postgres_changes', { event: '*', table: 'Lobby_Signals' }, syncLobby)
          .subscribe();

        if(!user) window.location.href = 'index.html';
        else syncLobby();
    </script>
</body>
</html>
